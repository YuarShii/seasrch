<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shop Demo - Shopee Style</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary-color: #ee4d2d;
        --bg-color: #f5f5f5;
        --white: #ffffff;
        --text-color: #333;
        --border-color: #e8e8e8;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      }
      body {
        background-color: var(--bg-color);
        color: var(--text-color);
      }

      /* HEADER */
      header {
        background: linear-gradient(-180deg, #f53d2d, #f63);
        padding: 10px 0;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .header-container {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 10px 20px;
      }
      .logo {
        color: var(--white);
        font-size: 24px;
        font-weight: bold;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .search-box {
        flex: 1;
        background: var(--white);
        border-radius: 2px;
        display: flex;
        padding: 3px;
      }
      .search-input {
        flex: 1;
        border: none;
        outline: none;
        padding: 0 10px;
        font-size: 14px;
      }
      .search-btn {
        background: var(--primary-color);
        border: none;
        width: 60px;
        height: 34px;
        border-radius: 2px;
        cursor: pointer;
        color: white;
      }
      .cart-icon {
        color: white;
        font-size: 24px;
        margin-left: 20px;
        cursor: pointer;
      }

      /* MAIN LAYOUT */
      .container {
        max-width: 1200px;
        margin: 20px auto;
        display: flex;
        gap: 20px;
        padding: 0 10px;
      }

      /* SIDEBAR FILTERS */
      .sidebar {
        width: 200px;
        flex-shrink: 0;
      }
      .filter-group {
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding-bottom: 20px;
      }
      .filter-title {
        font-weight: bold;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
      }
      .category-list {
        list-style: none;
      }
      .category-item {
        padding: 5px 0;
        cursor: pointer;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .category-item:hover,
      .category-item.active {
        color: var(--primary-color);
      }
      .category-item.active {
        font-weight: bold;
      }

      /* Price Filter */
      .price-inputs {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-bottom: 10px;
      }
      .price-input {
        width: 100%;
        height: 30px;
        border: 1px solid #ccc;
        font-size: 12px;
        padding: 0 5px;
        outline: none;
      }
      .btn-apply {
        width: 100%;
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 5px;
        text-transform: uppercase;
        font-size: 12px;
        cursor: pointer;
      }

      /* Rating Filter */
      .rating-item {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        padding: 4px 0;
        font-size: 13px;
      }
      .stars {
        color: #ffce3d;
      }

      /* MAIN CONTENT */
      .main-content {
        flex: 1;
      }

      /* SORT BAR */
      .sort-bar {
        background: rgba(0, 0, 0, 0.03);
        padding: 13px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        border-radius: 2px;
        margin-bottom: 10px;
        font-size: 14px;
      }
      .sort-label {
        color: #555;
        margin-right: 5px;
      }
      .sort-btn {
        border: none;
        padding: 0 15px;
        height: 34px;
        border-radius: 2px;
        cursor: pointer;
        background: var(--white);
      }
      .sort-btn.active {
        background: var(--primary-color);
        color: white;
      }
      .page-controller {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* PRODUCT GRID */
      .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
        gap: 10px;
      }

      /* PRODUCT CARD */
      .product-card {
        background: var(--white);
        border: 1px solid transparent;
        cursor: pointer;
        transition: transform 0.1s;
        position: relative;
      }
      .product-card:hover {
        border: 1px solid var(--primary-color);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 1;
      }

      /* Placeholder Image since no real images */
      .product-img {
        width: 100%;
        padding-top: 100%; /* 1:1 Aspect Ratio */
        background: #f2f2f2;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .img-placeholder {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #999;
        font-size: 40px;
        background: linear-gradient(45deg, #f1f1f1, #e1e1e1);
      }
      .product-info {
        padding: 10px;
      }
      .product-name {
        font-size: 12px;
        line-height: 14px;
        height: 28px;
        overflow: hidden;
        text-overflow: ellipsis;

        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;

        line-clamp: 2;

        margin-bottom: 5px;
      }
      .product-tags {
        display: flex;
        gap: 5px;
        margin-bottom: 5px;
      }
      .tag-mall {
        background: #d0011b;
        color: white;
        font-size: 10px;
        padding: 0 2px;
        border-radius: 2px;
      }

      .product-price-row {
        display: flex;
        align-items: baseline;
        gap: 5px;
        margin-bottom: 5px;
        flex-wrap: wrap;
      }
      .price-original {
        text-decoration: line-through;
        color: #999;
        font-size: 12px;
      }
      .price-current {
        color: var(--primary-color);
        font-size: 16px;
      }

      .product-meta {
        display: flex;
        justify-content: space-between;
        font-size: 10px;
        color: #757575;
        align-items: center;
      }
      .stars-small {
        color: #ffce3d;
      }

      /* Pagination Bottom */
      .pagination {
        margin-top: 40px;
        display: flex;
        justify-content: center;
        gap: 15px;
      }
      .page-btn {
        background: transparent;
        border: none;
        font-size: 20px;
        color: #999;
        cursor: pointer;
      }
      .page-btn.active {
        background: var(--primary-color);
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 2px;
        font-size: 16px;
      }

      /* Loading */
      #loading {
        text-align: center;
        padding: 20px;
        font-size: 18px;
        color: var(--primary-color);
        display: none;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-container">
        <a href="#" class="logo" onclick="resetFilters()"
          ><i class="fas fa-shopping-bag"></i> Shopee Demo</a
        >
        <div class="search-box">
          <input
            type="text"
            id="searchInput"
            class="search-input"
            placeholder="Tìm sản phẩm, thương hiệu..."
          />
          <button class="search-btn" onclick="applySearch()">
            <i class="fas fa-search"></i>
          </button>
        </div>
        <div class="cart-icon"><i class="fas fa-shopping-cart"></i></div>
      </div>
    </header>

    <div class="container">
      <aside class="sidebar">
        <div class="filter-group">
          <div class="filter-title">
            <i class="fas fa-list"></i> Tất Cả Danh Mục
          </div>
          <ul class="category-list" id="categoryList">
            <li class="category-item active">Đang tải...</li>
          </ul>
        </div>

        <div class="filter-group">
          <div class="filter-title">
            <i class="fas fa-filter"></i> Khoảng Giá
          </div>
          <div class="price-inputs">
            <input
              type="number"
              id="priceMin"
              class="price-input"
              placeholder="₫ TỪ"
            />
            <span>-</span>
            <input
              type="number"
              id="priceMax"
              class="price-input"
              placeholder="₫ ĐẾN"
            />
          </div>
          <button class="btn-apply" onclick="applyPrice()">Áp dụng</button>
        </div>

        <div class="filter-group">
          <div class="filter-title"><i class="fas fa-star"></i> Đánh Giá</div>
          <div class="rating-list">
            <div class="rating-item" onclick="applyRating(5)">
              <span class="stars"
                ><i class="fas fa-star"></i><i class="fas fa-star"></i
                ><i class="fas fa-star"></i><i class="fas fa-star"></i
                ><i class="fas fa-star"></i
              ></span>
              <span>trở lên</span>
            </div>
            <div class="rating-item" onclick="applyRating(4)">
              <span class="stars"
                ><i class="fas fa-star"></i><i class="fas fa-star"></i
                ><i class="fas fa-star"></i><i class="fas fa-star"></i
                ><i class="far fa-star"></i
              ></span>
              <span>trở lên</span>
            </div>
            <div class="rating-item" onclick="applyRating(3)">
              <span class="stars"
                ><i class="fas fa-star"></i><i class="fas fa-star"></i
                ><i class="fas fa-star"></i><i class="far fa-star"></i
                ><i class="far fa-star"></i
              ></span>
              <span>trở lên</span>
            </div>
          </div>
        </div>
      </aside>

      <main class="main-content">
        <div class="sort-bar">
          <span class="sort-label">Sắp xếp theo</span>
          <button class="sort-btn active" onclick="applySort(0, this)">
            Mới Nhất
          </button>
          <button class="sort-btn" onclick="applySort(3, this)">
            Bán Chạy
          </button>
          <button class="sort-btn" onclick="applySort(1, this)">
            Giá Thấp
          </button>
          <button class="sort-btn" onclick="applySort(2, this)">Giá Cao</button>

          <div class="page-controller">
            <span id="pageInfo">1/1</span>
            <button class="sort-btn" onclick="changePage(-1)">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button class="sort-btn" onclick="changePage(1)">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>

        <div id="loading">Đang tải sản phẩm...</div>

        <div class="product-grid" id="productGrid"></div>

        <div class="pagination" id="paginationBottom"></div>
      </main>
    </div>

    <script>
      // CẤU HÌNH API
      const API_URL = "http://127.0.0.1:8000/api";

      // TRẠNG THÁI HIỆN TẠI (STATE)
      let currentState = {
        tu_khoa: "",
        gia_min: null,
        gia_max: null,
        danh_muc: null,
        sao_toi_thieu: null,
        sap_xep: 0, // 0: Mới nhất
        page: 1,
        page_size: 12,
      };

      // --- HÀM KHỞI TẠO ---
      async function init() {
        await loadCategories();
        await fetchProducts();
      }

      // --- 1. LẤY DANH MỤC TỪ API ---
      async function loadCategories() {
        try {
          const res = await fetch(`${API_URL}/danh-muc`);
          const data = await res.json();
          const list = document.getElementById("categoryList");

          // Reset list và thêm nút "Tất cả"
          list.innerHTML = `<li class="category-item ${
            currentState.danh_muc === null ? "active" : ""
          }" onclick="applyCategory(null, this)">Tất cả</li>`;

          if (data.data) {
            data.data.forEach((cat) => {
              list.innerHTML += `<li class="category-item" onclick="applyCategory('${cat}', this)">${cat}</li>`;
            });
          }
        } catch (e) {
          console.error("Lỗi tải danh mục:", e);
        }
      }

      // --- 2. GỌI API TÌM KIẾM SẢN PHẨM ---
      async function fetchProducts() {
        document.getElementById("loading").style.display = "block";
        document.getElementById("productGrid").innerHTML = "";

        try {
          // Xây dựng URL Query String
          let url = new URL(`${API_URL}/san-pham/tim-kiem`);
          if (currentState.tu_khoa)
            url.searchParams.append("tu_khoa", currentState.tu_khoa);
          if (currentState.gia_min)
            url.searchParams.append("gia_min", currentState.gia_min);
          if (currentState.gia_max)
            url.searchParams.append("gia_max", currentState.gia_max);
          if (currentState.danh_muc)
            url.searchParams.append("danh_muc", currentState.danh_muc);
          if (currentState.sao_toi_thieu)
            url.searchParams.append(
              "sao_toi_thieu",
              currentState.sao_toi_thieu
            );
          url.searchParams.append("sap_xep", currentState.sap_xep);
          url.searchParams.append("page", currentState.page);
          url.searchParams.append("page_size", currentState.page_size);

          const res = await fetch(url);
          const products = await res.json();

          renderProducts(products);
        } catch (e) {
          console.error("Lỗi tải sản phẩm:", e);
          document.getElementById("productGrid").innerHTML =
            '<p style="padding:20px">Không tải được dữ liệu (Check API)</p>';
        } finally {
          document.getElementById("loading").style.display = "none";
          updatePaginationUI();
        }
      }

      // --- 3. RENDER GIAO DIỆN SẢN PHẨM ---
      function renderProducts(products) {
        const grid = document.getElementById("productGrid");

        if (products.length === 0) {
          grid.innerHTML =
            '<p style="grid-column: 1/-1; text-align:center; padding: 20px;">Không tìm thấy sản phẩm nào.</p>';
          return;
        }

        products.forEach((p) => {
          // Tạo icon placeholder ngẫu nhiên
          const icon = p.tenDanhMuc.includes("Điện")
            ? "fa-mobile-alt"
            : p.tenDanhMuc.includes("Thời")
            ? "fa-tshirt"
            : "fa-box";

          // Định dạng tiền tệ
          const price = new Intl.NumberFormat("vi-VN", {
            style: "currency",
            currency: "VND",
          }).format(p.giaBan);

          // Render thẻ HTML
          const html = `
                <div class="product-card">
                    <div class="product-img">
                        <div class="img-placeholder">
                            <i class="fas ${icon}" style="font-size: 30px; margin-bottom: 5px;"></i>
                            <span style="font-size: 10px;">SHOP DEMO</span>
                        </div>
                        ${
                          p.phanTramGiamGia > 0
                            ? `<div style="position:absolute; top:0; right:0; background:#f63; color:white; font-size:10px; padding:2px 4px;">-${Math.round(
                                p.phanTramGiamGia
                              )}%</div>`
                            : ""
                        }
                    </div>
                    <div class="product-info">
                        <div class="product-name">${p.tenSanPham}</div>
                        <div class="product-tags">
                            <span class="tag-mall">Mall</span>
                        </div>
                        <div class="product-price-row">
                            <span class="price-current">${price}</span>
                        </div>
                        <div class="product-meta">
                            <div class="rating">
                                ${renderStars(p.diemDanhGiaTB)}
                            </div>
                            <div>Đã bán ${
                              p.soLuongCon > 0 ? "nhiều" : "hết"
                            }</div>
                        </div>
                        <div class="product-meta" style="margin-top:5px; font-size:9px;">
                            ${p.tenCuaHang}
                        </div>
                    </div>
                </div>
                `;
          grid.innerHTML += html;
        });
      }

      function renderStars(rating) {
        if (!rating) return "";
        let html = '<span class="stars-small">';
        for (let i = 1; i <= 5; i++) {
          if (i <= rating) html += '<i class="fas fa-star"></i>';
          else html += '<i class="far fa-star"></i>';
        }
        html += `</span>`;
        return html;
      }

      // --- CÁC HÀM XỬ LÝ SỰ KIỆN (FILTERS) ---

      function applySearch() {
        currentState.tu_khoa = document.getElementById("searchInput").value;
        currentState.page = 1;
        fetchProducts();
      }

      function applyCategory(catName, element) {
        // Update Active UI
        document
          .querySelectorAll(".category-item")
          .forEach((el) => el.classList.remove("active"));
        element.classList.add("active");

        currentState.danh_muc = catName;
        currentState.page = 1;
        fetchProducts();
      }

      function applyPrice() {
        const min = document.getElementById("priceMin").value;
        const max = document.getElementById("priceMax").value;
        currentState.gia_min = min ? parseFloat(min) : null;
        currentState.gia_max = max ? parseFloat(max) : null;
        currentState.page = 1;
        fetchProducts();
      }

      function applyRating(stars) {
        currentState.sao_toi_thieu = stars;
        currentState.page = 1;
        fetchProducts();
      }

      function applySort(sortValue, btnElement) {
        document
          .querySelectorAll(".sort-btn")
          .forEach((el) => el.classList.remove("active"));
        btnElement.classList.add("active");

        currentState.sap_xep = sortValue;
        currentState.page = 1;
        fetchProducts();
      }

      function changePage(delta) {
        if (currentState.page + delta < 1) return;
        currentState.page += delta;
        fetchProducts();
      }

      function updatePaginationUI() {
        document.getElementById(
          "pageInfo"
        ).innerText = `Trang ${currentState.page}`;
      }

      function resetFilters() {
        currentState = {
          ...currentState,
          page: 1,
          danh_muc: null,
          tu_khoa: "",
        };
        loadCategories(); // Reset UI danh mục
        fetchProducts();
      }

      // Enter search
      document
        .getElementById("searchInput")
        .addEventListener("keypress", function (event) {
          if (event.key === "Enter") applySearch();
        });

      // CHẠY APP
      init();
    </script>
  </body>
</html>
